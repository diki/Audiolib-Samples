<!DOCTYPE html>
<html>
<head>
    <script src="js/audiolib.js"></script>
    <script src="plugins/loop-sequencer.js"></script>
    <script src="samples/drum-samples.js"></script>

    <script src="http://code.jquery.com/jquery-1.9.1.min.js"></script>7


    <script>
        var dev = Sink(),
            kick    = audioLib.Sampler(dev.sampleRate),
            snare   = audioLib.Sampler(dev.sampleRate),
            hat = audioLib.Sampler(dev.sampleRate),
            seq = audioLib.LoopSequencer(dev.sampleRate),
            rev = audioLib.Reverb(dev.sampleRate, dev.channelCount, 0.5, 0.99);

        var kickLocations = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]; 
        var snareLocations = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
        var hatLocations = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];

        var activeInstrument = {
            sequence: kickLocations,
            instrument: kick
        };

        kick.loadWav(atob(samples.kick));
        snare.loadWav(atob(samples.snare));
        hat.loadWav(atob(samples.hihat));

        seq.getMix = function (ch) {
            return kick.getMix(ch) + snare.getMix(ch) + hat.getMix(ch);
        };

        seq.ongenerate = function () {
            kick.generate();
            snare.generate();
            hat.generate();
        };

        dev.on('audioprocess', function (buffer, channelCount) {
            seq.append(buffer, channelCount);
            rev.append(buffer, channelCount);
        });

        seq.tempo = 132;
        seq.length = 2;

        window.onload = function(){
            var canvas      = document.createElement('canvas'),
            context     = canvas.getContext('2d'),
            width       = canvas.width = 800,
            height      = canvas.height = 600;
                    
            canvas.width = width;
            document.body.appendChild(canvas);

            
        }
    </script>
</head>
<body>
    <style>
        body {
            background: #1a1e1f;
        }

        tr.line {
            line-height: 10px;
        }
        tr.line td {
            background-color: #fff;
            text-align: center;
            width: 32px;
        }
        tr.line td div{
            width: 6px;
            height: 6px;
            border-radius: 12px;
            background: #AAA;
            margin: 0 auto;
        }

        tr.line td.active div{
            background: red;
        }

        tr.buttons {
            line-height: 10px;
        }
        tr.buttons td {
            background-color: #fff;
            text-align: center;
            width: 32px;
        }
        tr.buttons td div{
            width: 16px;
            height: 16px;
            background: #AAA;
            margin: 0 auto;
        }

        tr.buttons td.active div{
            background: red;
        }
    </style>
    <table id="beats">
        <tr class="line">
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>
            <td>
                <div></div>
            </td>           
        </tr>
        <tr class="buttons">
            <td data-idx="0">
                <div></div>
            </td>
            <td data-idx="1">
                <div></div>
            </td>
            <td data-idx="2">
                <div></div>
            </td>
            <td data-idx="3">
                <div></div>
            </td>
            <td data-idx="4">
                <div></div>
            </td>
            <td data-idx="5">
                <div></div>
            </td>
            <td data-idx="6">
                <div></div>
            </td>
            <td data-idx="7">
                <div></div>
            </td>
            <td data-idx="8">
                <div></div>
            </td>
            <td data-idx="9">
                <div></div>
            </td>
            <td data-idx="10">
                <div></div>
            </td>
            <td data-idx="11">
                <div></div>
            </td>
            <td data-idx="12">
                <div></div>
            </td>
            <td data-idx="13">
                <div></div>
            </td>
            <td data-idx="14">
                <div></div>
            </td>
            <td data-idx="15">
                <div></div>
            </td>           
        </tr>       
    </table>
    <script>
var beats = [].slice.call(document.querySelectorAll('#beats tr.line td'));

function getBeat () {
    var b = (seq.position - (dev.writePosition - dev.getPlaybackTime()) *
        60 / seq.tempo / seq.sampleRate);
    return b < 0 ? b + seq.length : b % seq.length;
}

setInterval(function () {
    /* We multiply by four to get the index of the box we want to highlight. */
    var index, i;
    index = ~~(getBeat() * 8);

    for (i=0; i<beats.length; i++) {
        if (i === index) {
            beats[i].classList.add('active');
        } else {
            beats[i].classList.remove('active');
        }
    }
}, 1000/60);
    </script>

    <script type="text/javascript">
        $(document).ready(function(){
            $("tr.buttons td").click(function(){
                var idx = $(this).attr("data-idx");
                console.log(idx);
                if(activeInstrument.sequence[idx]==0){
                    activeInstrument.sequence[idx] = 1;
                    $(this).addClass("active");
                    seq.addEvent(activeInstrument.instrument, idx/8);
                } else {
                    console.log("hehehehe", idx);
                    activeInstrument.sequence[idx] = 0;
                    $(this).removeClass("active");
                    seq.removeEvent(idx/8);
                }
            });
        });
    </script>
</body>
</html>
